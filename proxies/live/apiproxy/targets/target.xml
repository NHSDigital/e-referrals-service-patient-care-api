<TargetEndpoint name="e-referrals-service-patient-care-api-target">
  <PreFlow>
    <Request>
      <Step>
        <Name>OauthV2.VerifyAccessToken</Name>
      </Step>
      <Step>
        <Name>FlowCallout.ApplyRateLimiting</Name>
      </Step>
      <Step>
        <Name>AssignMessage.AddBaseUrlHeader</Name>
      </Step>
      <Step>
        <Name>AssignMessage.RemoveAndAddApplicationIdHeader</Name>
      </Step>
      <Step>
        <Name>DecodeJWT.DecodeIdToken</Name>
      </Step>
      <Step>
        <Name>javascript.SetNhsNumber</Name>
      </Step>
      <Step>
        <Name>AssignMessage.RemoveAndAddNhsNumberHeader</Name>
      </Step>
      <Step>
        <Name>AssignMessage.RemoveAndAddAccessTokenHeader</Name>
      </Step>
      <Step>
        <Name>AssignMessage.Remove.x-request-id-header</Name>
      </Step>
      {% if ALLOW_ECHO_TARGET | default(false) == true %} <Step>
        <Name>AssignMessage.SetEchoTarget</Name>
        <Condition>(request.header.echo)</Condition>
      </Step> {% endif %}
     <Step>
        <Name>Python.DecodeBase64TargetIdentifier</Name>
        <Condition>request.header.NHSD-Target-Identifier != null</Condition>
      </Step>
      <Step>
        <Name>Javascript.ValidateTarget</Name>
        <Condition>targetIdentifierDecoded != null</Condition>
      </Step>
      <Step>
        <Name>RaiseFault.InvalidTargetIdentifier</Name>
        <Condition>request.header.NHSD-Target-Identifier = null or targetIdentifierValid = false</Condition>
      </Step>
      <Step>
        <!--This should always be the last Step - as it is just before the message is sent - so the initial request stays intact for as long as possible.
            The Swapping of the Request Headers converts x-correlation-id to nhsd-correlation-id before sending to backend. -->
        <Name>AssignMessage.Swap.CorrelationHeader</Name>
      </Step>
    </Request>
    <Response>
            <!-- Any steps that apply to response might have to be duplicated in DefaultFaultRule section so that they also apply
           to response on non success status code e.g. 200/201, Take care when updating these steps-->
            <Step>
                <Name>AssignMessage.SetFlagCustomHeaderXRequestId</Name>
            </Step>
            <Step>
                <Name>AssignMessage.Swap.TransactionID</Name>
                <Condition>(response.header.nhsd-ers-transaction-id ~~ ".+")</Condition>
            </Step>
            <Step>
                <Name>AssignMessage.Remove.nhsd-correlation-id-header</Name>
                <Condition>(response.header.nhsd-correlation-id ~~ ".+")</Condition>
            </Step>
        </Response>
  </PreFlow>
  <FaultRules>
    <FaultRule name="access_token_expired">
      <Step>
        <Name>ExtractVariables.OAuthErrorFaultString</Name>
      </Step>
      <Step>
        <Name>AssignMessage.OAuthPolicyErrorResponse</Name>
      </Step>
      <Condition>oauthV2.OauthV2.VerifyAccessToken.failed</Condition>
    </FaultRule>
  </FaultRules>
  <DefaultFaultRule>
    <Step>
      <Name>AssignMessage.Errors.CatchAllMessage</Name>
    </Step>
  </DefaultFaultRule>
  <HTTPTargetConnection>
      <SSLInfo>{% if '--ft-' in (ERS_TARGET_SERVER | default('e-referrals-service-patient-care-api')) %}
        <TrustStore>ref://e-referral-service-ca</TrustStore> {% endif %}
        <Enabled>true</Enabled>
      </SSLInfo>
      <LoadBalancer>
        <Server name="{{ ERS_TARGET_SERVER | default('e-referrals-service-patient-care-api') }}"/>
      </LoadBalancer>
      <Path>/v1</Path>
      <Properties>
        <Property name="supports.http10">true</Property>
        <Property name="request.retain.headers">User-Agent,Referer,Accept-Language</Property>
        <Property name="retain.queryparams">apikey</Property>
      </Properties>
  </HTTPTargetConnection>
</TargetEndpoint>
