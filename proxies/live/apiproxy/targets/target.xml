<TargetEndpoint name="e-referrals-service-patient-care-api-target">
  <PreFlow>
    <Request>
      <Step>
        <Name>OauthV2.VerifyAccessToken</Name>
      </Step>
      <Step>
        <Name>FlowCallout.ApplyRateLimiting</Name>
      </Step>
      {% if ALLOW_ECHO_TARGET | default(false) == true %} <Step>
        <Name>AssignMessage.SetEchoTarget</Name>
        <Condition>(request.header.echo)</Condition>
      </Step> {% endif %}
    </Request>
  </PreFlow>
  <FaultRules>
    <FaultRule name="access_token_expired">
      <Step>
        <Name>ExtractVariables.OAuthErrorFaultString</Name>
      </Step>
      <Step>
        <Name>AssignMessage.OAuthPolicyErrorResponse</Name>
      </Step>
      <Condition>oauthV2.OauthV2.VerifyAccessToken.failed</Condition>
    </FaultRule>
  </FaultRules>
  <HTTPTargetConnection>
      <SSLInfo>{% if '--ft-' in (ERS_TARGET_SERVER | default('e-referrals-service-patient-care-api')) %}
        <TrustStore>ref://e-referral-service-ca</TrustStore> {% endif %}
        <Enabled>true</Enabled>
      </SSLInfo>
      <LoadBalancer>
        <Server name="{{ ERS_TARGET_SERVER | default('e-referrals-service-patient-care-api') }}"/>
      </LoadBalancer>
      <Path>/v1</Path>
      <Properties>
        <Property name="supports.http10">true</Property>
        <Property name="request.retain.headers">User-Agent,Referer,Accept-Language</Property>
        <Property name="retain.queryparams">apikey</Property>
      </Properties>
  </HTTPTargetConnection>
</TargetEndpoint>
