SERVICE_NAME: e-referrals-service-patient-care-api
PRODUCT_DISPLAY_NAME: e-referrals-service-patient-care-api
DESCRIPTION: e-RS Patient Care API

# The request_limit and burst_limit variables included here define the ratelimiting applied to each policy. 
# The request_limit variable defines how many requests can be made to the referenced proxy over 8 hours, 
# whereas the burst_limit defines how many requests can be sent to the reference proxy as a spike of traffic.
APIGEE_ENVIRONMENTS:
    - name: internal-dev
      display_name: Internal Development
      request_limit: '600'
      burst_limit: '900pm'
    - name: internal-dev-sandbox
      display_name: Internal Development Sandbox
    - name: int
      display_name: Integration Testing
      request_limit: '600'
      burst_limit: '900pm'
    - name: internal-qa
      display_name: Internal QA
      request_limit: '600'
      burst_limit: '900pm'
    - name: internal-qa-sandbox
      display_name: Internal QA Sandbox
    - name: ref
      display_name: Reference
    - name: sandbox
      display_name: Sandbox
    - name: prod
      approval_type: manual
      display_name: Production

INTERNAL_DEV_VARIANTS:
    - name: alpha
    - name: rc
    - name: fix
    - name: ft01
      service: fti
    - name: ft04
      service: ftiv
    - name: ft05
      service: ftv
    - name: ft09
      service: ftix
    - name: ft22
      service: ftxxii
---
meta:
  api:
    name: e-referrals-service-patient-care-api
    guid: 6792bc27-4aca-420f-a347-bbf6f2fcae10
    spec_guids:
      - 66f6b5ed-072a-4a38-a864-f79bba63dbe7
  schema_version: 1.3
apigee:
  environments:
{% for ENV in APIGEE_ENVIRONMENTS %}
{% set TITLE = 'e-Referral Service Patient Care' %}
{% set NAME = SERVICE_NAME + '-' + ENV.name %}
{% if ENV.name == 'internal-dev' %}
  - name: {{ ENV.name }}
    products:
{% for VARIANT in INTERNAL_DEV_VARIANTS %}
      - name: {{ SERVICE_NAME }}-{{ VARIANT.service | default(VARIANT.name) }}-{{ ENV.name }}
        approvalType: {{ ENV.approval_type | default('auto') }}
        attributes:
          - name: access
            value: public
          - name: ratelimiting
            value:
              {{ SERVICE_NAME }}-{{ VARIANT.service | default(VARIANT.name) }}-{{ ENV.name }}:
                quota:
                  enabled: false
                spikeArrest:
                  enabled: false
          - name: requestLimit_referral
            value: {{ ENV.request_limit | default('6000') }}
          - name: requestLimit_general
            value: {{ ENV.request_limit | default('6000') }}
          - name: burstLimit_referral
            value: {{ ENV.burst_limit | default('9000pm') }}
          - name: burstLimit_general
            value: {{ ENV.burst_limit | default('9000pm') }}
        description: {{ DESCRIPTION }}
        displayName: {{ TITLE }} ({{ ENV.display_name}} - {{ VARIANT.name }})
        environments: [ {{ ENV.name }} ]
        proxies:
          - {{ SERVICE_NAME }}-{{ VARIANT.service | default(VARIANT.name) }}-{{ ENV.name }}
          - identity-service-{{ ENV.name }}
          - identity-service-mock-{{ ENV.name }}
        scopes:
          - 'urn:nhsd:apim:user-nhs-login:P9:{{ SERVICE_NAME }}'
{% endfor %}
    specs:
{% for VARIANT in INTERNAL_DEV_VARIANTS %}
      - name: {{ SERVICE_NAME }}-{{ VARIANT.service | default(VARIANT.name) }}-{{ ENV.name }}
        path: {{ SERVICE_NAME }}.json
{% endfor %}
    api_catalog:
{% for VARIANT in INTERNAL_DEV_VARIANTS %}
      - edgeAPIProductName: {{ SERVICE_NAME }}-{{ VARIANT.service | default(VARIANT.name) }}-{{ ENV.name }}
        anonAllowed: true
        description: {{ DESCRIPTION }} ({{ ENV.display_name}} - {{ VARIANT.name }})
        requireCallbackUrl: false
        title: {{ TITLE }} ({{ ENV.display_name}} - {{ VARIANT.name }})
        visibility: false
        specId: {{ SERVICE_NAME }}-{{ VARIANT.service | default(VARIANT.name) }}-{{ ENV.name }}
{% endfor %}
{% else %}
  - name: {{ ENV.name }}
    products:
      - name: {{ NAME }}
        approvalType: {{ ENV.approval_type | default('auto') }}
        attributes:
          - name: access
            value: public
          - name: ratelimiting
            value:
              {{ NAME }}:
                quota: 
                  enabled: false
                spikeArrest:
                  enabled: false
          - name: requestLimit_referral
            value: {{ ENV.request_limit | default('2880000') }}
          - name: requestLimit_general
            value: {{ ENV.request_limit | default('2880000') }}
          - name: burstLimit_referral
            value: {{ ENV.burst_limit | default('6300pm') }}
          - name: burstLimit_general
            value: {{ ENV.burst_limit | default('6300pm') }}
        description: {{ DESCRIPTION }}
        displayName: {{ TITLE }} ({{ ENV.display_name }})
        environments: [ {{ ENV.name }} ]
        proxies:
          - {{ NAME }}
          - identity-service-{{ ENV.name }}
{% if ENV.name == 'int' %}
          - identity-service-int-no-smartcard
          - identity-service-mock-{{ ENV.name }}
{% endif %}
{% if ENV.name == 'internal-qa' %}
          - identity-service-{{ ENV.name }}-int
          - identity-service-mock-{{ ENV.name }}
{% endif %}
        scopes:
          - 'urn:nhsd:apim:user-nhs-login:P9:{{ SERVICE_NAME }}'
    specs:
      - name: {{ NAME }}
        path: {{ SERVICE_NAME }}.json
    api_catalog:
      - edgeAPIProductName: {{ NAME }}
        anonAllowed: true
        description: {{ DESCRIPTION }}
        requireCallbackUrl: false
        title: {{ TITLE }} ({{ ENV.display_name}})
        visibility: false
        specId: {{ NAME }}
{% endif %}
{% endfor %}
